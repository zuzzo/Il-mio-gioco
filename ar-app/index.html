<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Geolocalizzata</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Babylon.js -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://cdn.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
    
    <!-- Meta tag per forzare HTTPS -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <!-- Gestione della geolocalizzazione e dell'AR -->
    <script src="scripts/geo-manager.js" defer></script>
    <script src="scripts/ar-manager.js" defer></script>
    <script src="scripts/app.js" defer></script>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>AR Geolocalizzata</h1>
            <div id="statusMessage">Caricamento...</div>
        </header>
        
        <main class="app-content">
            <div class="ar-view-container">
                <div class="ar-frame-border">
                    <div class="ar-view" id="ar-view">
                        <video id="camera-feed" autoplay playsinline muted></video>
                        <canvas id="renderCanvas"></canvas>
                        <div id="directionArrow" class="hidden">↑</div>
                    </div>
                </div>
                
                <!-- Slider per rotazione e dimensione -->
                <div id="rotationSliderContainer" class="slider-container hidden">
                    <label for="rotationSlider">Rotazione:</label>
                    <input type="range" id="rotationSlider" min="0" max="360" value="0" class="slider">
                    <span id="rotationValue">0°</span>
                </div>
                
                <div id="scaleSliderContainer" class="slider-container hidden">
                    <label for="scaleSlider">Dimensione:</label>
                    <input type="range" id="scaleSlider" min="1" max="30" value="10" class="slider">
                    <span id="scaleValue">1.0x</span>
                </div>
                
                <div class="ar-info-panel">
                    <div id="distance" class="hidden"></div>
                    <div id="direction" class="hidden"></div>
                    <div id="orientationInfo" class="hidden"></div>
                    <div id="savedDataInfo" class="hidden"></div>
                </div>
            </div>
            
            <div class="model-selection">
                <label for="model-select">Seleziona oggetto 3D:</label>
                <select id="model-select">
                    <option value="assets/models/treasure.glb">Forziere</option>
                    <option value="assets/models/key.glb">Chiave</option>
                    <option value="assets/models/door.glb">Porta</option>
                    <option value="assets/models/custom.glb">Oggetto personalizzato</option>
                </select>
                
                <div class="file-upload hidden">
                    <label for="custom-model">Carica modello 3D (.glb):</label>
                    <input type="file" id="custom-model" accept=".glb,.gltf">
                </div>
            </div>
            
            <div class="control-buttons">
                <button id="getLocationBtn" class="primary-btn">Ottieni posizione</button>
                <button id="placeObjectBtn" class="primary-btn" disabled>Posiziona oggetto</button>
                <button id="startARBtn" class="primary-btn" disabled>Visualizza in AR</button>
                <button id="clearDataBtn" class="danger-btn">Cancella dati</button>
            </div>
        </main>
        
        <footer class="app-footer">
            <button id="debugBtn" class="info-btn">Debug</button>
            <button id="toggleCameraDebugBtn" class="info-btn">Debug Camera</button>
        </footer>
    </div>
    
    <!-- Notifiche browser -->
    <div id="browserNotification" class="notification hidden">
        <p>Per una migliore esperienza, è consigliato utilizzare Microsoft Edge o Google Chrome su dispositivi Android.</p>
        <button class="close-notification">Chiudi</button>
    </div>
    
    <!-- Pannello di debug della fotocamera -->
    <div id="cameraDebugPanel" class="debug-panel hidden">
        <h3>Debug Fotocamera</h3>
        <div id="cameraStatus">In attesa...</div>
        <div class="debug-info">
            <div><strong>Video Element:</strong> <span id="videoElementStatus">-</span></div>
            <div><strong>Stream Info:</strong> <span id="streamInfo">-</span></div>
            <div><strong>Errori:</strong> <span id="cameraErrors">-</span></div>
            <div><strong>Dimensioni:</strong> <span id="videoDimensions">-</span></div>
            <div><strong>Play State:</strong> <span id="videoPlayState">-</span></div>
        </div>
        <div class="debug-actions">
            <button id="forceCameraBtn">Forza Camera</button>
            <button id="refreshVideoBtn">Aggiorna Video</button>
            <button id="showHiddenDataBtn">Mostra Dati</button>
        </div>
    </div>
    
    <script>
        // Script per gestire gli slider di rotazione e dimensione
        document.addEventListener('DOMContentLoaded', function() {
            const rotationSlider = document.getElementById('rotationSlider');
            const rotationValue = document.getElementById('rotationValue');
            const scaleSlider = document.getElementById('scaleSlider');
            const scaleValue = document.getElementById('scaleValue');
            
            // Aggiorna il valore della rotazione quando lo slider cambia
            rotationSlider.addEventListener('input', function() {
                const angle = parseInt(this.value);
                rotationValue.textContent = angle + '°';
                
                // Ottieni l'istanza ARManager e aggiorna la rotazione
                if (window.ARManager) {
                    const arManager = window.app ? window.app.arManager : null;
                    if (arManager) {
                        arManager.setObjectRotation(angle);
                    }
                }
            });
            
            // Aggiorna il valore della scala quando lo slider cambia
            scaleSlider.addEventListener('input', function() {
                const scale = parseInt(this.value) / 10; // Dividi per 10 per avere valori decimali 0.1-3.0
                scaleValue.textContent = scale.toFixed(1) + 'x';
                
                // Ottieni l'istanza ARManager e aggiorna la scala
                if (window.ARManager) {
                    const arManager = window.app ? window.app.arManager : null;
                    if (arManager) {
                        arManager.setObjectScale(scale);
                    }
                }
            });
        });
    </script>
</body>
</html>